"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
var react_1 = __importStar(require("react"));
var attr_accept_1 = __importDefault(require("attr-accept"));
var Icon_1 = require("../Icon/Icon");
var styleguide_1 = require("../styleguide");
var Typography_1 = __importDefault(require("../Typography/Typography"));
var FileUploader_styles_1 = require("./FileUploader.styles");
var isAcceptedFileType = function (files, accept) {
    if (accept) {
        // for now we are only allowing single file upload but this could change in the future which
        // will change how the validation happens
        return (0, attr_accept_1.default)({ name: files[0].name, type: files[0].type }, accept);
    }
    return true;
};
var FileUploader = function (_a) {
    var onDrop = _a.onDrop, onChange = _a.onChange, _b = _a.isDisabled, isDisabled = _b === void 0 ? false : _b, subtitle = _a.subtitle, dataQA = _a.dataQA, accept = _a.accept, errorMessage = _a.errorMessage, props = __rest(_a, ["onDrop", "onChange", "isDisabled", "subtitle", "dataQA", "accept", "errorMessage"]);
    var _c = (0, react_1.useState)(false), dragActive = _c[0], setDragActive = _c[1];
    var _d = (0, react_1.useState)(false), showValidationError = _d[0], setShowValidationError = _d[1];
    var _e = (0, react_1.useState)(false), uploadButtonIsFocused = _e[0], setUploadButtonIsFocused = _e[1];
    var inputRef = (0, react_1.useRef)(null);
    var handleClick = function (event) {
        event.stopPropagation();
        if (isDisabled) {
            return;
        }
        if (inputRef.current) {
            inputRef.current.click();
            inputRef.current.value = "";
        }
    };
    var handleDragOver = function (event) {
        event.preventDefault();
        event.stopPropagation();
        if (isDisabled) {
            return;
        }
        if (event.type === "dragenter" || event.type === "dragover") {
            setDragActive(true);
            // reset validation error when dragging new file
            if (showValidationError) {
                setShowValidationError(false);
            }
        }
        else if (event.type === "dragleave") {
            setDragActive(false);
        }
    };
    var handleDrop = function (event) {
        event.preventDefault();
        event.stopPropagation();
        setDragActive(false);
        if (isAcceptedFileType(event.dataTransfer.files, accept)) {
            setShowValidationError(false);
            onDrop(event);
        }
        else {
            setShowValidationError(true);
            onDrop(null);
        }
    };
    var handleOnChange = function (event) {
        setShowValidationError(false);
        onChange(event);
    };
    var getIconColor = function () {
        if (isDisabled) {
            return styleguide_1.colors.darkerGray;
        }
        if (dragActive) {
            return styleguide_1.colors.midBlue;
        }
        return styleguide_1.colors.black;
    };
    var uploadButtonAriaLabel = "Click to upload or drag and drop files";
    if (accept) {
        uploadButtonAriaLabel = "".concat(uploadButtonAriaLabel, ", supports ").concat(accept.split(",").join(", "));
    }
    return (react_1.default.createElement(FileUploader_styles_1.FileUploaderWrapper, __assign({ m: props.m, mb: props.mb, ml: props.ml, mr: props.mr, mt: props.mt }, props),
        react_1.default.createElement(FileUploader_styles_1.StyledUploaderWrapper, { dragActive: dragActive, uploadButtonIsFocused: uploadButtonIsFocused, onClick: handleClick, onDragEnter: handleDragOver, isDisabled: isDisabled, "data-qa": dataQA, showValidationError: showValidationError },
            react_1.default.createElement(FileUploader_styles_1.FileUploaderInput, { "data-qa": "".concat(dataQA, "-file-upload-input"), type: "file", ref: inputRef, onChange: handleOnChange, accept: accept, disabled: isDisabled, "aria-describedby": "file upload" }),
            react_1.default.createElement(Icon_1.Icon, { name: "Upload", size: 20, color: getIconColor() }),
            react_1.default.createElement(FileUploader_styles_1.FileUploaderTitle, null,
                react_1.default.createElement(FileUploader_styles_1.UploadButton, { dataQA: "".concat(dataQA, "-upload-button"), buttonText: "Click to Upload", "aria-label": uploadButtonAriaLabel, onClick: handleClick, disabled: isDisabled, onFocus: function () { return setUploadButtonIsFocused(true); }, onBlur: function () { return setUploadButtonIsFocused(false); } }),
                react_1.default.createElement(Typography_1.default, { dataQA: "drag-and-drop-text", variant: "bodyCopyBold", component: "span", color: isDisabled ? "".concat(styleguide_1.colors.black, "A8") : styleguide_1.colors.black }, "or drag and drop files")),
            subtitle && (react_1.default.createElement(Typography_1.default, { dataQA: "file-uploader-subtitle", mt: styleguide_1.spacingMap.xxs, variant: "caption", color: "".concat(styleguide_1.colors.black, "A8") }, subtitle)),
            dragActive &&
                react_1.default.createElement(FileUploader_styles_1.DragFileElement, { "data-qa": "file-uploader-drag-file-element", onDragEnter: handleDragOver, onDragLeave: handleDragOver, onDragOver: handleDragOver, onDrop: handleDrop })),
        react_1.default.createElement(FileUploader_styles_1.ErrorMessageWrapper, { "aria-live": "polite" }, showValidationError && (react_1.default.createElement(react_1.default.Fragment, null,
            react_1.default.createElement(Icon_1.Icon, { name: "CircleAlert", color: styleguide_1.colors.red, size: 14 }),
            react_1.default.createElement(Typography_1.default, { dataQA: "error-message-text", color: styleguide_1.colors.red, id: "file upload" }, errorMessage || "Incorrect File Type"))))));
};
exports.default = FileUploader;
//# sourceMappingURL=FileUploader.js.map